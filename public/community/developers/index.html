<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.81.0" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Developer Guide | Krustlet</title><meta property="og:title" content="Developer Guide" />
<meta property="og:description" content="Developer guide This guide explains how to set up your environment for developing Krustlet.
Prerequisites To build krustlet, you will need
 The latest stable version of Rust The latest version of just openssl (Or use the rustls-tls feature) git  If you want to test krustlet, you will also require
 A Kubernetes cluster The latest version of kubectl  If you want to compile your own WebAssembly modules and upload them to a registry, you&rsquo;ll need wasm-to-oci." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://docs.krustlet.dev/community/developers/" /><meta property="article:section" content="community" />

<meta property="og:site_name" content="Krustlet" />

<meta itemprop="name" content="Developer Guide">
<meta itemprop="description" content="Developer guide This guide explains how to set up your environment for developing Krustlet.
Prerequisites To build krustlet, you will need
 The latest stable version of Rust The latest version of just openssl (Or use the rustls-tls feature) git  If you want to test krustlet, you will also require
 A Kubernetes cluster The latest version of kubectl  If you want to compile your own WebAssembly modules and upload them to a registry, you&rsquo;ll need wasm-to-oci.">

<meta itemprop="wordCount" content="853">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Developer Guide"/>
<meta name="twitter:description" content="Developer guide This guide explains how to set up your environment for developing Krustlet.
Prerequisites To build krustlet, you will need
 The latest stable version of Rust The latest version of just openssl (Or use the rustls-tls feature) git  If you want to test krustlet, you will also require
 A Kubernetes cluster The latest version of kubectl  If you want to compile your own WebAssembly modules and upload them to a registry, you&rsquo;ll need wasm-to-oci."/>









<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="//fonts.googleapis.com/css2?family=Poppins:wght@700&family=Work+Sans&display=swap" rel="stylesheet">


<link rel="stylesheet" href="/css/style.984d0cac551d1e618acdbae32aed044ef29a6f388b1a5c5e1193689b6445c90d.css" integrity="sha256-mE0MrFUdHmGKzbrjKu0ETvKabziLGlxeEZNom2RFyQ0=">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css" />



  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand flex-column flex-md-row td-navbar">
	
	<div class="deislabs">
		<a href="https://deislabs.io/" title="Deis Labs">
			<span>Deis Labs</span>
			<div class="shapes top"><em class="dl-tr"></em><em class="dl-sq"></em><em class="dl-ci"></em></div>
		</a>
	</div>
	<a class="navbar-brand" href="/">
		<span class="text-uppercase font-weight-bold">Krustlet</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://krustlet.dev" target="_blank" ><span>Home</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://docs.krustlet.dev" target="_blank" ><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/deislabs/krustlet/" target="_blank" ><span>Github</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://kubernetes.slack.com/messages/krustlet" target="_blank" ><span>Slack</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://twitter.com/krustlet" target="_blank" ><span>Twitter</span></a>
			</li>
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Releases 
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="https://docs.krustlet.dev">v0.7.0</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
	
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-3 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    


<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.59616654c3bfdc16be8f9dd0f8c7d4098b085d188474d154dbd361cbacd53f5dc104423f9001c90cc16edf2835d27dfb8f6ac36acfe812cbaee597f651510a1b.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/community/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Krustlet documentation</a>
  </li>
  <ul>
    <li class="collapse show" id="community">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-communitycode-of-conduct" href="/community/code-of-conduct/">Code of Conduct</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-communitydevelopers" href="/community/developers/">Developer Guide</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-communityrelease-checklist" href="/community/release-checklist/">Release Checklist</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          
          <main class="col-12 col-md-9 col-xl-9 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none breadcrumb-wrapper">
	<ol class="breadcrumb spb-1">
		







<li class="breadcrumb-item" >
	<a href="https://docs.krustlet.dev/community/">Krustlet documentation</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="https://docs.krustlet.dev/community/developers/">Developer Guide</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>Developer Guide</h1>
	<h1 id="developer-guide">Developer guide</h1>
<p>This guide explains how to set up your environment for developing Krustlet.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To build krustlet, you will need</p>
<ul>
<li>The latest stable version of Rust</li>
<li>The latest version of <a href="https://github.com/casey/just">just</a></li>
<li>openssl (Or use the <a href="#building-without-openssl"><code>rustls-tls</code></a> feature)</li>
<li>git</li>
</ul>
<p>If you want to test krustlet, you will also require</p>
<ul>
<li>A Kubernetes cluster</li>
<li>The latest version of
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a></li>
</ul>
<p>If you want to compile your own WebAssembly modules and upload them to a
registry, you&rsquo;ll need <a href="https://github.com/engineerd/wasm-to-oci">wasm-to-oci</a>.</p>
<p>If you want to build the Docker image, you&rsquo;ll need
<a href="https://docs.docker.com/install/">Docker</a>.</p>
<h2 id="building">Building</h2>
<p>We use <code>just</code> to build our programs, but you can use <code>cargo</code> if you want:</p>
<pre><code class="language-console" data-lang="console">$ just build
</code></pre><h3 id="building-without-openssl">Building without openssl</h3>
<p>If you are on a system that doesn&rsquo;t have OpenSSL (or has the incorrect version),
you have the option to build Krustlet using the Rustls project (Rust native TLS
implementation):</p>
<pre><code class="language-console" data-lang="console">$ just build --no-default-features --features rustls-tls
</code></pre><p>The same flags can be passed to <code>just run</code> if you want to just <a href="#running">run</a>
the project instead.</p>
<h4 id="caveats">Caveats</h4>
<p>The underlying dependencies for Rustls do not support certs with IP SANs
(subject alternate names). Because of this, the serving certs requested during
bootstrap will not work for local development options like minikube or KinD as
they do not have an FQDN</p>
<h3 id="building-on-wsl-windows-subsystem-for-linux">Building on WSL (Windows Subsystem for Linux)</h3>
<p>You can build Krustlet on WSL but will need a few prerequisites that aren&rsquo;t
included in the Ubuntu distro in the Microsoft Store:</p>
<pre><code class="language-console" data-lang="console">$ sudo apt install build-essential libssl-dev pkg-config
</code></pre><p><strong>NOTE:</strong> We&rsquo;ve had mixed success developing Krustlet on WSL.  It has been
successfully run on WSL2 using the WSL2-enabled Docker Kubernetes or Azure
Kubernetes.  If you&rsquo;re on WSL1 you may be better off running in a full Linux VM
under Hyper-V.</p>
<h3 id="building-on-windows">Building on Windows</h3>
<p>As of version 0.4, we have support for building on Windows. For convenience
sake, there is a windows version of the justfile called <code>justfile-windows</code>. This
justfile uses PowerShell and has the proper flags set for Windows builds. To use
it, you&rsquo;ll have to specify the justfile using the <code>--justfile</code> flag like so:</p>
<pre><code class="language-console" data-lang="console">$ just --justfile justfile-windows build
</code></pre><p>It has all the same targets as the normal justfile, however, the <code>test</code> target
runs a little differently than the normal target due to how we use feature
flags. This means there will be some spurious warning output from <code>clippy</code>, but
the tests will run.</p>
<p><strong>NOTE:</strong> Windows builds use the <code>rustls</code> library, which means there are some
things to be aware of. See the <a href="#caveats">caveats</a> section for more details</p>
<h2 id="running">Running</h2>
<p>The default included runtime with Krustlet is <code>wasi</code>.</p>
<p>The <code>wasi</code> runtime uses a project called
<a href="https://github.com/bytecodealliance/wasmtime"><code>wasmtime</code></a>. wasmtime is a
standalone JIT-style host runtime for WebAssembly modules. It is focused
primarily on standards compliance with the WASM specification as it relates to
<a href="https://wasi.dev/">WASI</a>. If your WebAssembly module complies with the
<a href="https://github.com/WebAssembly/spec">WebAssembly specification</a>, wasmtime can
run it.</p>
<p>Before startup, this command will delete any nodes in your Kubernetes cluster
named with your hostname, so make sure you&rsquo;re running this in a test
environment.</p>
<p>If you want to interact with the kubelet (for things like <code>kubectl logs</code> and
<code>kubectl exec</code>), you&rsquo;ll likely need to set a specific KRUSTLET_NODE_IP that
krustlet will be available at. Otherwise, calls to the kubelet will result in
errors. This may differ from machine to machine. For example, with Minikube on a
Mac, you&rsquo;ll have an interface called <code>bridge0</code> which the cluster can talk to. So
your node IP should be that IP address.</p>
<p>To set the node IP, run:</p>
<pre><code class="language-console" data-lang="console">$ export KRUSTLET_NODE_IP=&lt;the ip address&gt;
</code></pre><h2 id="testing">Testing</h2>
<p>Krustlet contains both integration and unit tests. For convenience, there are
<code>just</code> targets for running one or the other.</p>
<p>For unit tests:</p>
<pre><code class="language-console" data-lang="console">$ just test
</code></pre><p>For the integration tests, start a WASI node in a separate terminal before
running the tests.</p>
<p>In terminal 1:</p>
<pre><code class="language-console" data-lang="console">$ just run-wasi
</code></pre><p>And in terminal 2:</p>
<pre><code class="language-console" data-lang="console">$ just test-e2e
</code></pre><p>You can run the integration tests without creating additional terminals or
manually running the kubelets by running:</p>
<pre><code class="language-console" data-lang="console">$ just test-e2e-standalone
</code></pre><p>This:</p>
<ul>
<li>Bootstraps and approves certificates if necessary</li>
<li>Runs the WASI kubelet in the background</li>
<li>Runs the integration tests</li>
<li>Terminates the kubelets when the integration tests complete</li>
<li>Reports test failures, and saves the kubelet logs if any tests failed</li>
</ul>
<p>You <strong>will</strong> still need to set <code>KRUSTLET_NODE_IP</code> because the tester doesn&rsquo;t
know what kind of Kubernetes cluster you&rsquo;re using and so doesn&rsquo;t know how to
infer a node IP.</p>
<p><em>WARNING:</em> The standalone integration tester has not been, er, tested on
Windows. Hashtag irony.</p>
<h3 id="integration-test-debris">Integration test debris</h3>
<p>There are some failure modes - for example image pull timeout - where the
integration tests are not able to complete cleanup of their resources.
Specifically you can sometimes get pods stuck in <code>Terminating</code>, which prevents
namespace cleanup and causes the next test run to break.</p>
<p>You can forcibly clean up such debris by running <code>cargo run --bin podsmiter</code>.
You may need to wait a couple of minutes after pod deletion for the namespaces
to be collected.</p>
<h2 id="creating-your-own-kubelets-with-krustlet">Creating your own Kubelets with Krustlet</h2>
<p>If you want to create your own Kubelet based on Krustlet, all you need to do is
implement a <code>Provider</code>.</p>
<p>See <code>src/krustlet-wasi.rs</code> and its corresponding provider implementation in
<code>crates/wasi-provider</code> to get started.</p>

	
	
</div>


          </main>
        </div>
      </div>
      

<footer class="py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-6 text-xs-center order-sm-2">
        <p class="footer-cncf">Krustlet</p>
      </div>
      <div class="col-6 col-sm-6 text-right text-xs-center order-sm-3">
        <ul class="inline list-inline text-right">
          
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://krustlet.dev" target="_blank" ><span>Home</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://docs.krustlet.dev" target="_blank" ><span>Docs</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://github.com/deislabs/krustlet/" target="_blank" ><span>Github</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://kubernetes.slack.com/messages/krustlet" target="_blank" ><span>Slack</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://twitter.com/krustlet" target="_blank" ><span>Twitter</span></a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>



    </div>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>










<script src="/js/main.min.63db3e552bd0543be17ce4a79a18b744e9cb72256bec42b540e3ab0cd43722d0.js" integrity="sha256-Y9s&#43;VSvQVDvhfOSnmhi3ROnLciVr7EK1QOOrDNQ3ItA=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
