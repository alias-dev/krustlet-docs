<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.81.0" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Writing your first app, part 2 | Krustlet</title><meta property="og:title" content="Writing your first app, part 2" />
<meta property="og:description" content="This tutorial begins where Tutorial 1 left off. We’ll walk through the process to set up your personal registry and publish your application to that registry.
For this tutorial, we will be creating a registry hosted on Microsoft Azure, but there are other cloud providers that provide their own solutions, and you can run one on your own infrastructure, too!
What is a registry, and what is wasm-to-oci? A registry allows you to store your local WebAssembly modules in the cloud." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://docs.krustlet.dev/intro/tutorial02/" /><meta property="article:section" content="intro" />

<meta property="og:site_name" content="Krustlet" />

<meta itemprop="name" content="Writing your first app, part 2">
<meta itemprop="description" content="This tutorial begins where Tutorial 1 left off. We’ll walk through the process to set up your personal registry and publish your application to that registry.
For this tutorial, we will be creating a registry hosted on Microsoft Azure, but there are other cloud providers that provide their own solutions, and you can run one on your own infrastructure, too!
What is a registry, and what is wasm-to-oci? A registry allows you to store your local WebAssembly modules in the cloud.">

<meta itemprop="wordCount" content="1048">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Writing your first app, part 2"/>
<meta name="twitter:description" content="This tutorial begins where Tutorial 1 left off. We’ll walk through the process to set up your personal registry and publish your application to that registry.
For this tutorial, we will be creating a registry hosted on Microsoft Azure, but there are other cloud providers that provide their own solutions, and you can run one on your own infrastructure, too!
What is a registry, and what is wasm-to-oci? A registry allows you to store your local WebAssembly modules in the cloud."/>









<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="//fonts.googleapis.com/css2?family=Poppins:wght@700&family=Work+Sans&display=swap" rel="stylesheet">


<link rel="stylesheet" href="/css/style.984d0cac551d1e618acdbae32aed044ef29a6f388b1a5c5e1193689b6445c90d.css" integrity="sha256-mE0MrFUdHmGKzbrjKu0ETvKabziLGlxeEZNom2RFyQ0=">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css" />



  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand flex-column flex-md-row td-navbar">
	
	<div class="deislabs">
		<a href="https://deislabs.io/" title="Deis Labs">
			<span>Deis Labs</span>
			<div class="shapes top"><em class="dl-tr"></em><em class="dl-sq"></em><em class="dl-ci"></em></div>
		</a>
	</div>
	<a class="navbar-brand" href="/">
		<span class="text-uppercase font-weight-bold">Krustlet</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://krustlet.dev" target="_blank" ><span>Home</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://docs.krustlet.dev" target="_blank" ><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/deislabs/krustlet/" target="_blank" ><span>Github</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://kubernetes.slack.com/messages/krustlet" target="_blank" ><span>Slack</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://twitter.com/krustlet" target="_blank" ><span>Twitter</span></a>
			</li>
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Releases 
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="https://docs.krustlet.dev">v0.7.0</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
	
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-3 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    


<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.59616654c3bfdc16be8f9dd0f8c7d4098b085d188474d154dbd361cbacd53f5dc104423f9001c90cc16edf2835d27dfb8f6ac36acfe812cbaee597f651510a1b.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/intro/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Introduction to Krustlet</a>
  </li>
  <ul>
    <li class="collapse show" id="intro">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-introinstall" href="/intro/install/">Install Krustlet</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-introintro" href="/intro/intro/">Introduction</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-introquickstart" href="/intro/quickstart/">Quick Start</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-introreadnext" href="/intro/readnext/">What to read next</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-introtutorial01" href="/intro/tutorial01/">Writing your first app, part 1</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-introtutorial02" href="/intro/tutorial02/">Writing your first app, part 2</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-introtutorial03" href="/intro/tutorial03/">Writing your first app, part 3</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          
          <main class="col-12 col-md-9 col-xl-9 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none breadcrumb-wrapper">
	<ol class="breadcrumb spb-1">
		







<li class="breadcrumb-item" >
	<a href="https://docs.krustlet.dev/intro/">Introduction to Krustlet</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="https://docs.krustlet.dev/intro/tutorial02/">Writing your first app, part 2</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>Writing your first app, part 2</h1>
	<p>This tutorial begins where <a href="tutorial01.md">Tutorial 1</a> left off. We’ll walk
through the process to set up your personal registry and publish your
application to that registry.</p>
<p>For this tutorial, we will be creating a registry hosted on Microsoft Azure, but
there are other cloud providers that provide their own solutions, and you can
<a href="https://github.com/docker/distribution">run one on your own infrastructure</a>,
too!</p>
<h2 id="what-is-a-registry-and-what-is-wasm-to-oci">What is a registry, and what is wasm-to-oci?</h2>
<p>A registry allows you to store your local WebAssembly modules in the cloud. With
a registry, you can backup your personal modules, share your projects, and
collaborate with others.</p>
<p><a href="https://github.com/engineerd/wasm-to-oci">wasm-to-oci</a> is an open source project that understands how to communicate
with a registry. It takes a module you&rsquo;ve built locally on your computer and
publishes it to the registry, making it publicly available for others to access.</p>
<h2 id="create-a-registry">Create a registry</h2>
<p>This tutorial uses the Azure CLI to create an Azure Container Registry. We will
be using this registry to publish our modules and provide Krustlet the URL for
fetching these modules.</p>
<p>The steps here assume you have an Azure account and the <code>az</code> CLI installed.
However, there are other cloud providers available with their own solutions, and
if you&rsquo;re feeling particularly brave, you can <a href="https://github.com/docker/distribution">run your own registry on your own
infrastructure</a>.</p>
<h3 id="create-a-resource-group">Create a resource group</h3>
<p>An Azure resource group is a logical container into which Azure resources are
deployed and managed.</p>
<p>The following example creates a resource group named <code>myResourceGroup</code> in the
<code>eastus</code> region. You may want to change it to a region closer to you. You can
find out what regions are available with <code>az account list-locations</code>, and you
can set your default region with <code>az configure --defaults location=&lt;location&gt;</code>.</p>
<p>Create a resource group with the <code>az group create</code> command.</p>
<pre><code class="language-console" data-lang="console">$ az group create --name myResourceGroup --location eastus
</code></pre><h3 id="create-a-container-registry">Create a container registry</h3>
<p>In this tutorial, we will be creating a basic registry, which is cost-optimized
for developers learning about Azure Container Registry. For details on available
service tiers, see <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-skus">Container registry
SKUs</a>
in the Azure documentation.</p>
<p>Create an ACR instance using the <code>az acr create command</code>. The registry name must
be unique within Azure, and contain 5-50 alphanumeric characters.</p>
<p>In the following example, <code>mycontainerregistry007</code> is used as the name. Update
this to a unique value.</p>
<pre><code class="language-console" data-lang="console">$ az acr create --sku Basic --resource-group myResourceGroup --name mycontainerregistry007
</code></pre><p>When the registry is created, the output is similar to the following:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="font-weight:bold">&#34;adminUserEnabled&#34;</span>: <span style="color:#fff;font-weight:bold">false</span>,
  <span style="font-weight:bold">&#34;creationDate&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-01-08T22:32:13.175925+00:00&#34;</span>,
  <span style="font-weight:bold">&#34;id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.ContainerRegistry/registries/mycontainerregistry007&#34;</span>,
  <span style="font-weight:bold">&#34;location&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;eastus&#34;</span>,
  <span style="font-weight:bold">&#34;loginServer&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;mycontainerregistry007.azurecr.io&#34;</span>,
  <span style="font-weight:bold">&#34;name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;mycontainerregistry007&#34;</span>,
  <span style="font-weight:bold">&#34;provisioningState&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Succeeded&#34;</span>,
  <span style="font-weight:bold">&#34;resourceGroup&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;myResourceGroup&#34;</span>,
  <span style="font-weight:bold">&#34;sku&#34;</span>: {
    <span style="font-weight:bold">&#34;name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Basic&#34;</span>,
    <span style="font-weight:bold">&#34;tier&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Basic&#34;</span>
  },
  <span style="font-weight:bold">&#34;status&#34;</span>: <span style="color:#fff;font-weight:bold">null</span>,
  <span style="font-weight:bold">&#34;storageAccount&#34;</span>: <span style="color:#fff;font-weight:bold">null</span>,
  <span style="font-weight:bold">&#34;tags&#34;</span>: {},
  <span style="font-weight:bold">&#34;type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Microsoft.ContainerRegistry/registries&#34;</span>
}
</code></pre></div><p>Take note of the <code>loginServer</code> field. That is the URL for our registry. We&rsquo;ll
need to know that when we publish our application in a bit.</p>
<h3 id="log-in">Log in</h3>
<p>Now that our registry was created, we can go ahead and authenticate with this
registry to publish our application:</p>
<pre><code class="language-console" data-lang="console">$ az acr login --name mycontainerregistry007
</code></pre><h2 id="publish-your-app">Publish your app</h2>
<p>Now that we&rsquo;ve created our registry and are logged in, we can publish our
application using <a href="https://github.com/engineerd/wasm-to-oci">wasm-to-oci</a>.</p>
<p>wasm-to-oci is a tool for publishing WebAssembly modules to a registry. It
packages the module and uploads it to the registry. Krustlet understands the
registry API and will fetch the module based on the URL you uploaded it to.</p>
<p>To publish our application, we need to come up with a name and a version number.
Our <code>loginServer</code> field from earlier was <code>mycontainerregistry007.azurecr.io</code>,
and we want to name our application <code>krustlet-tutorial</code>, version <code>v1.0.0</code>.</p>
<p>The pattern for a registry URL is:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&lt;URL&gt;/&lt;NAME&gt;:&lt;VERSION&gt;
</code></pre></div><p>In our case, our application URL will look like
<code>mycontainerregistry007.azurecr.io/krustlet-tutorial:v1.0.0</code>. Great!</p>
<p>Let&rsquo;s publish that now:</p>
<pre><code class="language-console" data-lang="console">$ wasm-to-oci push demo.wasm mycontainerregistry007.azurecr.io/krustlet-tutorial:v1.0.0
</code></pre><p><code>demo.wasm</code> is the filename of the WebAssembly module we compiled during <a href="tutorial01.md">part
1</a> of this tutorial. If you are publishing the Rust example, use
<code>target/wasm32-wasi/debug/demo.wasm</code> instead.</p>
<h2 id="create-a-container-registry-pull-secret">Create a container registry pull secret</h2>
<p>Unless your container registry is enabled with anonymous access, you need to
authenticate krustlet to pull images from it. At the moment, there is no flag
in the Azure portal to make a registry public, but you can
<a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-faq#how-do-i-enable-anonymous-pull-access">create a support ticket</a>
to have it enabled manually.</p>
<p>Without public access to the container registry, you need to create a
<em>Kubernetes pull secret</em>. The steps below for Azure are
<a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-auth-kubernetes">extracted from the Azure documentation</a>,
and repeated here for convenience.</p>
<h3 id="create-a-service-principal-and-assign-a-role-in-azure">Create a service principal and assign a role in Azure</h3>
<p>Below is a bash script that will create a service principal for pulling images
for the registry. Replace <code>&lt;container-registry-name&gt;</code> with
<code>mycontainerregistry007</code>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#0f0;font-weight:bold">#!/bin/bash
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#007f7f"># Modify for your environment.</span>
<span style="color:#007f7f"># ACR_NAME: The name of your Azure Container Registry</span>
<span style="color:#007f7f"># SERVICE_PRINCIPAL_NAME: Must be unique within your AD tenant</span>
ACR_NAME=&lt;container-registry-name&gt;
SERVICE_PRINCIPAL_NAME=acr-service-principal

<span style="color:#007f7f"># Obtain the full registry ID for subsequent command args</span>
ACR_REGISTRY_ID=<span style="color:#fff;font-weight:bold">$(</span>az acr show --name $ACR_NAME --query id --output tsv<span style="color:#fff;font-weight:bold">)</span>

<span style="color:#007f7f"># Create the service principal with rights scoped to the registry.</span>
<span style="color:#007f7f"># Default permissions are for docker pull access. Modify the &#39;--role&#39;</span>
<span style="color:#007f7f"># argument value as desired:</span>
<span style="color:#007f7f"># acrpull:     pull only</span>
<span style="color:#007f7f"># acrpush:     push and pull</span>
<span style="color:#007f7f"># owner:       push, pull, and assign roles</span>
SP_PASSWD=<span style="color:#fff;font-weight:bold">$(</span>az ad sp create-for-rbac --name http://$SERVICE_PRINCIPAL_NAME --scopes $ACR_REGISTRY_ID --role acrpull --query password --output tsv<span style="color:#fff;font-weight:bold">)</span>
SP_APP_ID=<span style="color:#fff;font-weight:bold">$(</span>az ad sp show --id http://$SERVICE_PRINCIPAL_NAME --query appId --output tsv<span style="color:#fff;font-weight:bold">)</span>

<span style="color:#007f7f"># Output the service principal&#39;s credentials; use these in your services and</span>
<span style="color:#007f7f"># applications to authenticate to the container registry.</span>
<span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Service principal ID: </span>$SP_APP_ID<span style="color:#0ff;font-weight:bold">&#34;</span>
<span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;Service principal password: </span>$SP_PASSWD<span style="color:#0ff;font-weight:bold">&#34;</span>
</code></pre></div><p>If you do not want to create a service principal in Azure, you can also use the
registry <code>Admin</code> username and password which gives full access to the registry
and is not generally recommended. This is not enabled by default. Go to the
Azure portal and the settings for your registry and the <code>Access keys</code> menu.
There you can enable <code>Admin</code> access and use the associated username instead of
the service principal ID and the password when creating the pull secret below.</p>
<h3 id="use-the-service-principal">Use the service principal</h3>
<p>Create an image pull secret in Kubernetes:</p>
<pre><code class="language-console" data-lang="console">kubectl create secret docker-registry &lt;acr-secret-name&gt; \
    --namespace &lt;namespace&gt; \
    --docker-server=mycontainerregistry007.azurecr.io \
    --docker-username=&lt;service-principal-ID&gt; \
    --docker-password=&lt;service-principal-password&gt;
</code></pre><p>where <code>&lt;acr-secret-name&gt;</code> is a name you give this secret,
<code>&lt;service-principal-ID&gt;</code> and <code>&lt;service-principal-password&gt;</code> are taken from the
output of the bash script above. The <code>--namespace</code> can be omitted if you are
using the default Kubernetes namespace.</p>
<h2 id="next-steps">Next steps</h2>
<p>When you’re comfortable with publishing your application with wasm-to-oci, read
<a href="tutorial03.md">part 3 of this tutorial</a> to install your application.</p>

	
	
</div>


          </main>
        </div>
      </div>
      

<footer class="py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-6 text-xs-center order-sm-2">
        <p class="footer-cncf">Krustlet</p>
      </div>
      <div class="col-6 col-sm-6 text-right text-xs-center order-sm-3">
        <ul class="inline list-inline text-right">
          
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://krustlet.dev" target="_blank" ><span>Home</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://docs.krustlet.dev" target="_blank" ><span>Docs</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://github.com/deislabs/krustlet/" target="_blank" ><span>Github</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://kubernetes.slack.com/messages/krustlet" target="_blank" ><span>Slack</span></a>
          </li>
          
          <li class="nav-item list-inline-item mr-4 mb-2 mb-lg-0">
            
            
            
            
            <a class="nav-link" href="https://twitter.com/krustlet" target="_blank" ><span>Twitter</span></a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>



    </div>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>










<script src="/js/main.min.63db3e552bd0543be17ce4a79a18b744e9cb72256bec42b540e3ab0cd43722d0.js" integrity="sha256-Y9s&#43;VSvQVDvhfOSnmhi3ROnLciVr7EK1QOOrDNQ3ItA=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
